# PowerSync Sync Rules for MedZen-Iwani (COMPLETE VERSION)
# Multi-Role Healthcare Application with Database Views
# Supports: Patient, Medical Provider, Facility Admin, System Admin
#
# PREREQUISITES:
# 1. Run migration: supabase/migrations/20250122000000_powersync_multi_role_views.sql
# 2. Refresh views: SELECT refresh_powersync_materialized_views();
# 3. Deploy these rules to PowerSync Dashboard

bucket_definitions:
  # =====================================================
  # USER BUCKET - Basic user profile data (all roles)
  # =====================================================
  user_data:
    parameters: SELECT id::text as user_id FROM users WHERE firebase_uid = token_parameters.user_id()

    data:
      # User's own profile
      - SELECT * FROM users WHERE id::text = bucket.user_id

      # Role-specific profiles
      - SELECT * FROM patient_profiles WHERE user_id = bucket.user_id
      - SELECT * FROM medical_provider_profiles WHERE user_id = bucket.user_id
      - SELECT * FROM facility_admin_profiles WHERE user_id = bucket.user_id
      - SELECT * FROM system_admin_profiles WHERE user_id = bucket.user_id

      # User's EHR (if patient)
      - SELECT * FROM electronic_health_records WHERE patient_id = bucket.user_id

  # =====================================================
  # PATIENT BUCKET - Patient's own medical data
  # =====================================================
  patient_data:
    parameters: SELECT user_id FROM patient_profiles WHERE user_id IN (SELECT id::text FROM users WHERE firebase_uid = token_parameters.user_id())

    data:
      # Patient's medical records
      - SELECT * FROM vital_signs WHERE patient_id = bucket.user_id
      - SELECT * FROM lab_results WHERE patient_id = bucket.user_id
      - SELECT * FROM prescriptions WHERE patient_id = bucket.user_id
      - SELECT * FROM immunizations WHERE patient_id = bucket.user_id
      - SELECT * FROM medical_records WHERE patient_id = bucket.user_id
      - SELECT * FROM allergies WHERE patient_id = bucket.user_id

      # Patient's appointments
      - SELECT * FROM appointments WHERE patient_id = bucket.user_id

      # EHR sync queue for patient's data
      - SELECT * FROM ehrbase_sync_queue WHERE record_id = bucket.user_id

  # =====================================================
  # PROVIDER BUCKET - Provider's patients and their data
  # =====================================================
  provider_data:
    parameters: SELECT user_id as provider_user_id FROM medical_provider_profiles WHERE user_id IN (SELECT id::text FROM users WHERE firebase_uid = token_parameters.user_id())

    data:
      # Provider's accessible patients (via materialized view)
      - SELECT * FROM v_provider_accessible_patients WHERE provider_user_id = bucket.provider_user_id

      # Provider's appointments
      - SELECT * FROM v_provider_appointments WHERE provider_user_id = bucket.provider_user_id

      # Medical records of provider's patients (via materialized views)
      - SELECT * FROM v_provider_accessible_vital_signs WHERE provider_user_id = bucket.provider_user_id
      - SELECT * FROM v_provider_accessible_lab_results WHERE provider_user_id = bucket.provider_user_id
      - SELECT * FROM v_provider_accessible_prescriptions WHERE provider_user_id = bucket.provider_user_id
      - SELECT * FROM v_provider_accessible_medical_records WHERE provider_user_id = bucket.provider_user_id

      # Provider's schedule and availability
      - SELECT * FROM provider_availability WHERE provider_id IN (SELECT id FROM medical_provider_profiles WHERE user_id = bucket.provider_user_id)
      - SELECT * FROM provider_schedule_exceptions WHERE provider_id IN (SELECT id FROM medical_provider_profiles WHERE user_id = bucket.provider_user_id)

      # Facility assignments
      - SELECT * FROM facility_providers WHERE provider_id IN (SELECT id FROM medical_provider_profiles WHERE user_id = bucket.provider_user_id)

  # =====================================================
  # FACILITY ADMIN BUCKET - Facility-wide data access
  # =====================================================
  facility_admin_data:
    parameters: SELECT user_id as admin_user_id FROM facility_admin_profiles WHERE user_id IN (SELECT id::text FROM users WHERE firebase_uid = token_parameters.user_id())

    data:
      # All appointments at admin's facilities (via materialized view)
      - SELECT * FROM v_facility_admin_accessible_appointments WHERE admin_user_id = bucket.admin_user_id

      # All providers at admin's facilities (via materialized view)
      - SELECT * FROM v_facility_admin_accessible_providers WHERE admin_user_id = bucket.admin_user_id

      # All patients at admin's facilities (via materialized view)
      - SELECT * FROM v_facility_admin_accessible_patients WHERE admin_user_id = bucket.admin_user_id

      # Facility details
      - SELECT * FROM facilities WHERE id IN (SELECT facility_id FROM facility_admin_profiles WHERE user_id = bucket.admin_user_id)

      # Facility departments
      - SELECT * FROM facility_departments WHERE facility_id IN (SELECT facility_id FROM facility_admin_profiles WHERE user_id = bucket.admin_user_id)

      # Facility reports
      - SELECT * FROM facility_reports WHERE facility_id IN (SELECT facility_id FROM facility_admin_profiles WHERE user_id = bucket.admin_user_id)

  # =====================================================
  # SYSTEM ADMIN BUCKET - Full system access
  # =====================================================
  system_admin_data:
    parameters: SELECT user_id as admin_user_id FROM system_admin_profiles WHERE user_id IN (SELECT id::text FROM users WHERE firebase_uid = token_parameters.user_id())

    # NOTE: For system admins, we sync ALL data
    # Use a tautology with bucket parameter to satisfy PowerSync requirements
    data:
      # All users
      - SELECT * FROM users WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL

      # All profiles
      - SELECT * FROM patient_profiles WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL
      - SELECT * FROM medical_provider_profiles WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL
      - SELECT * FROM facility_admin_profiles WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL

      # All appointments
      - SELECT * FROM appointments WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL

      # All medical records
      - SELECT * FROM electronic_health_records WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL
      - SELECT * FROM vital_signs WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL
      - SELECT * FROM lab_results WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL
      - SELECT * FROM prescriptions WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL
      - SELECT * FROM immunizations WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL
      - SELECT * FROM medical_records WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL
      - SELECT * FROM allergies WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL

      # All facilities and related
      - SELECT * FROM facilities WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL
      - SELECT * FROM facility_providers WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL
      - SELECT * FROM facility_departments WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL
      - SELECT * FROM facility_reports WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL

      # All provider schedules
      - SELECT * FROM provider_availability WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL
      - SELECT * FROM provider_schedule_exceptions WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL

      # All sync queue entries
      - SELECT * FROM ehrbase_sync_queue WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL

      # System monitoring
      - SELECT * FROM user_activity_logs WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL
      - SELECT * FROM email_logs WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL
      - SELECT * FROM feedback WHERE id IS NOT NULL OR bucket.admin_user_id IS NOT NULL

  # =====================================================
  # GLOBAL BUCKET - Public reference data
  # =====================================================
  global:
    # No parameters - available to all authenticated users
    data:
      # Reference tables
      - SELECT * FROM facilities
      - SELECT * FROM facility_types
      - SELECT * FROM blood_types
      - SELECT * FROM specialties
      - SELECT * FROM countries
      - SELECT * FROM archetypes

# =====================================================
# DEPLOYMENT CHECKLIST
# =====================================================
#
# [ ] 1. Apply database migration
#        npx supabase db push
#
# [ ] 2. Refresh materialized views (first time)
#        Run in Supabase SQL Editor:
#        SELECT refresh_powersync_materialized_views();
#
# [ ] 3. Set up automatic view refresh (choose one):
#
#        Option A: pg_cron (requires extension)
#        CREATE EXTENSION IF NOT EXISTS pg_cron;
#        SELECT cron.schedule(
#            'refresh-powersync-views',
#            '*/5 * * * *',
#            'SELECT refresh_powersync_materialized_views();'
#        );
#
#        Option B: Supabase Edge Function (recommended)
#        See: supabase/functions/refresh-powersync-views/
#
# [ ] 4. Copy these rules to PowerSync Dashboard
#        - Go to: https://YOUR_INSTANCE.journeyapps.com/
#        - Navigate to: Sync Rules
#        - Paste this entire file
#        - Click: Save → Deploy
#
# [ ] 5. Test each role:
#        - Patient: Can see only their own data
#        - Provider: Can see their patients' data
#        - Facility Admin: Can see facility-wide data
#        - System Admin: Can see everything
#
# [ ] 6. Monitor sync performance
#        - Check PowerSync Dashboard → Metrics
#        - Monitor materialized view refresh time
#        - Adjust refresh frequency if needed
#
# =====================================================
