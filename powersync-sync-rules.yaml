# PowerSync Sync Rules for MedZen Iwani
# This configuration defines which data syncs to each user's device

bucket_definitions:
  # User's personal medical data bucket
  user_data:
    # Get the user's Supabase ID based on their Firebase UID from JWT token
    parameters: SELECT id as user_id FROM users WHERE firebase_uid = token_parameters.user_id()

    # Data to sync for this user
    data:
      # User's own profile
      - SELECT * FROM users WHERE id = bucket.user_id

      # User's EHR record
      - SELECT * FROM electronic_health_records WHERE patient_id = bucket.user_id

      # User's vital signs
      - SELECT * FROM vital_signs WHERE patient_id = bucket.user_id

      # User's lab results
      - SELECT * FROM lab_results WHERE patient_id = bucket.user_id

      # User's prescriptions
      - SELECT * FROM prescriptions WHERE patient_id = bucket.user_id

      # User's immunizations
      - SELECT * FROM immunizations WHERE patient_id = bucket.user_id

      # User's medical records
      - SELECT * FROM medical_records WHERE patient_id = bucket.user_id

      # User's EHRbase sync queue items
      - SELECT * FROM ehrbase_sync_queue
        WHERE (table_name = 'users_demographics' AND record_id = bucket.user_id::text)
        OR (table_name IN ('vital_signs', 'lab_results', 'prescriptions', 'immunizations', 'medical_records')
            AND record_id IN (
              SELECT id::text FROM vital_signs WHERE patient_id = bucket.user_id
              UNION
              SELECT id::text FROM lab_results WHERE patient_id = bucket.user_id
              UNION
              SELECT id::text FROM prescriptions WHERE patient_id = bucket.user_id
              UNION
              SELECT id::text FROM immunizations WHERE patient_id = bucket.user_id
              UNION
              SELECT id::text FROM medical_records WHERE patient_id = bucket.user_id
            ))

# Global parameters available to all bucket queries
parameters:
  # Extract user_id (Firebase UID) from JWT token's 'sub' claim
  user_id: SELECT request.jwt() ->> 'sub'
