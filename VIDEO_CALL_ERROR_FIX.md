# Video Call Error Fix Guide

## Errors Encountered

```
Invalid argument(s): No host specified in URI file:///500x500?doctor
Null check operator used on a null value at join_call_widget.dart:924:72
```

## Root Causes

### 1. Malformed Image URLs in Database
The `appointment_overview` view was returning malformed image URLs like `/500x500?doctor` instead of proper HTTP URLs. These malformed URLs were stored in:
- `users.avatar_url`
- `medical_provider_profiles.avatar_url`
- `facility_admin_profiles.avatar_url`
- `system_admin_profiles.avatar_url`
- `facilities.image_url`

### 2. Null Safety Issues in FlutterFlow Widget
The `join_call_widget.dart` file (FlutterFlow-generated) uses null assertion operators (`!`) on fields that can be null:
```dart
joinCallAppointmentOverviewRow!.appointmentId!
joinCallAppointmentOverviewRow!.providerId!
joinCallAppointmentOverviewRow!.patientId!
```

## Solutions Applied

### ‚úÖ Solution 1: Database Migration (COMPLETED)
Created migration `20251202120000_fix_malformed_image_urls.sql` that:
- Sets malformed avatar URLs to `NULL` across all user tables
- Adds database constraints to prevent future malformed URLs
- Ensures only valid HTTP/HTTPS URLs or NULL are allowed

**Applied:** Migration successfully pushed to Supabase.

### üîß Solution 2: FlutterFlow UI Configuration (REQUIRED)

Since `join_call_widget.dart` is auto-generated by FlutterFlow, you need to fix this in the FlutterFlow UI:

1. **Open FlutterFlow Project**
2. **Navigate to the Join Call Page**
3. **Find the "Start Call" button action**
4. **Modify the `joinRoom` action parameters:**
   - Change null assertion operators to safe null handling
   - Or ensure the appointment data is guaranteed to be non-null before the button is enabled

**Recommended Approach:** Add a conditional check before showing the "Start Call" button:
```dart
// Only show button if all required data is present
if (joinCallAppointmentOverviewRow?.appointmentId != null &&
    joinCallAppointmentOverviewRow?.providerId != null &&
    joinCallAppointmentOverviewRow?.patientId != null)
```

### üéØ Solution 3: Unused Parameters in joinRoom (OPTIMIZATION)

The `joinRoom` custom action accepts `userName` and `profileImage` parameters but **never uses them** (see lines 30-31 in `join_room.dart`). These can safely be:
- Removed from the function signature
- Or kept for future use (displaying participant info)

## Testing Steps

1. **Clear malformed data** (already done by migration)
2. **Upload new profile images** using the app's profile picture upload feature
3. **Test video call flow:**
   ```bash
   flutter run -d <device>
   # Navigate to Join Call page
   # Try starting a video call
   ```

4. **Verify no more errors** about malformed URIs

## Prevention

Database constraints are now in place to prevent malformed URLs:
- All avatar/image URLs must start with `http` or `https`
- URLs must be at least 10 characters long
- Or the field must be NULL

## Additional Notes

- The profile image parameters in `joinRoom` are currently unused
- Consider using them to display participant names/avatars in the video call UI
- The video call page stub (`chime_video_call_page_stub.dart`) could be enhanced to show this info

## Files Modified

1. `supabase/migrations/20251202120000_fix_malformed_image_urls.sql` - New migration
2. This guide: `VIDEO_CALL_ERROR_FIX.md`

## Next Steps

1. ‚úÖ Migration applied - malformed URLs cleaned
2. ‚ö†Ô∏è **YOU MUST:** Fix FlutterFlow UI to handle null values safely
3. üîÑ Test video calls after FlutterFlow re-export
4. üìù Consider enhancing video call UI with participant info
