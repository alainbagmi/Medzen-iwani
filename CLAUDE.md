# CLAUDE.md - MedZen Development Guide

Healthcare platform: FlutterFlow + Firebase Auth + Supabase + EHRbase + AWS Chime SDK + AWS Bedrock

## Quick Commands

| Action | Command |
|--------|---------|
| Clean & run web | `flutter clean && flutter pub get && flutter run -d chrome` |
| Run Android/iOS | `flutter run -d android` / `flutter run -d ios` |
| Analyze code | `dart analyze lib/ --fatal-infos --fatal-warnings` |
| Test all systems | `./test_all_systems.sh` |
| Deploy Supabase | `npx supabase functions deploy bedrock-ai-chat check-user chime-meeting-token chime-messaging send-push-notification sync-to-ehrbase generate-clinical-note start-medical-transcription chime-recording-callback chime-transcription-callback chime-entity-extraction cleanup-expired-recordings ingest-call-transcript finalize-call-draft storage-sign-url call-send-message upload-profile-picture cleanup-old-profile-pictures` |
| Firebase emulator | `cd firebase/functions && npm run serve` |
| Supabase logs | `npx supabase functions logs [name] --tail --follow` |
| Firebase logs | `firebase functions:log --limit 50` |

## Critical IDs & Versions

- **Firebase:** `medzen-bf20e` | **Supabase:** `noaeltglphdlkbflipit` | **AWS Region:** `eu-central-1`
- **Node.js:** 20.x | **Flutter:** >=3.0.0 <4.0.0 | **Chime SDK:** v3.19.0
- **Main PR Branch:** `ALINO` (NOT main) | **Supabase Pooler:** `aws-0-eu-central-1.pooler.supabase.com:6543`

## Non-Negotiable Rules

1. **Initialization Order** (`lib/main.dart:28-42`): Environment → Firebase → Supabase → Localizations → AppState → initializeMessaging()
2. **Never modify** `lib/flutter_flow/` (auto-generated by FlutterFlow). Analyzer warnings (~10k) are expected; ignore unused imports.
3. **Firebase Auth + Supabase Pattern:** Firebase-only auth; data stored in Supabase via `firebase_uid` column
4. **RLS Policies:** Must allow `auth.uid() IS NULL` for Firebase tokens (no Supabase session)
5. **Video Calls (Chime SDK v3):** Use `startVideoInput()`/`startAudioInput()` (v2 APIs deprecated)
   - Widget: `lib/custom_code/widgets/chime_meeting_enhanced.dart`
   - Action: `lib/custom_code/actions/join_room.dart`
   - CDN: `https://du6iimxem4mh7.cloudfront.net/assets/amazon-chime-sdk-medzen.min.js`
   - Provider-only creation; patients join via `appointmentId`
6. **Edge Functions:** Use HTTP (not `SupaFlow.client.functions.invoke()`); pass Firebase token in lowercase `x-firebase-token` header
7. **Migrations:** Never edit existing; create new: `supabase/migrations/YYYYMMDDHHMMSS_description.sql`
8. **UUIDs:** Never cast to TEXT; use native UUID
9. **Firebase Config:** Never hardcode credentials
10. **Pre-commit Hook** (`.git/hooks/pre-commit`): Protects critical Firebase functions. If fails: restore from git history
11. **PostGIS:** Use `updateUserLocation()`, `getNearby*()` (50km radius), `calculateDistanceKm()` (Haversine)
12. **FlutterFlow Conflicts:** Accept generated version; re-apply custom logic in `lib/custom_code/`

## Setup

```bash
git clone <repo> && cd medzen-iwani-t1nrnu && nvm use 20
flutter pub get && cd firebase/functions && npm install && cd ../..
npx supabase link --project-ref noaeltglphdlkbflipit
# Copy environment.json from team (not in git for security)
flutter devices && npx supabase status && node --version
```

**Troubleshooting:** Supabase not linked? → `npx supabase link --project-ref noaeltglphdlkbflipit` | Pod issues? → `cd ios && pod deintegrate && pod install`

## Mobile Development

**Android:** `flutter emulators launch emulator-5554 && flutter run -d emulator-5554` | Camera issues: `./fix_emulator_camera.sh`
**iOS:** `open -a Simulator && flutter run -d "iPhone 15"` | Pods: `cd ios && pod deintegrate && pod install`
**Permissions:** CAMERA, RECORD_AUDIO, ACCESS_FINE_LOCATION, INTERNET (Android) | NSCameraUsageDescription, NSMicrophoneUsageDescription, NSLocationWhenInUseUsageDescription (iOS)

## Testing

```bash
flutter test                          # Unit/widget tests
./test_all_systems.sh                # Comprehensive
./test_video_call_web_automated.sh   # Video calls
./test_role_based_ai_models_complete.sh  # AI chat
npx supabase db reset                # Reset migrations
```

## Debugging Quick Reference

| Issue | Fix |
|-------|-----|
| **401 INVALID_FIREBASE_TOKEN** | Header must be lowercase `x-firebase-token`. Call `getIdToken(true)` to force-refresh. |
| **403 PATIENT_CANNOT_CREATE** | Patients can't initiate calls. Only providers create meetings. Check `isProvider` param. |
| **404 NO_ACTIVE_CALL** | Meeting doesn't exist or inactive. Verify `sessionId` in `video_call_sessions`. |
| **410 MEETING_EXPIRED** | Meeting ended. Check `ended_at` timestamp in `video_call_sessions`. |
| **500** | Check logs: `npx supabase functions logs <name> --tail`. Verify env vars, AWS creds. |
| **Video blank** | Browser console: verify Chime SDK CDN loads. Check `startVideoInput()` called (not v2 API). |
| **RLS blocking** | Policy must allow `auth.uid() IS NULL OR user_id = auth.uid()`. Verify `firebase_uid` link. |
| **Transcription stuck** | Check `transcription_usage_daily` for AWS limits. Verify status in `video_call_sessions`. |
| **Live captions missing** | Check `_isProcessingTranscript` flag. Verify buffer accumulating. Check 12-sec timer. |
| **SOAP not populating** | Verify transcript in `call_transcripts`. Check `generate-soap-from-context` logs. |
| **Build fails** | `flutter clean && flutter pub get` |
| **iOS pods fail** | `cd ios && pod deintegrate && pod install` |

**Debug tools:** `flutter run -v` (verbose) | `flutter run -d chrome --profile` (profile) | Browser DevTools: `Ctrl+Shift+I`

## Git Workflow

- **Branch:** `ALINO` (main PR target, not main) | `git checkout -b feature/name ALINO`
- **Before push:** `git fetch origin ALINO && git rebase origin/ALINO && npm run lint && dart analyze lib/ --fatal-infos && flutter test`
- **FlutterFlow conflicts:** `git checkout --theirs lib/flutter_flow/ && git add lib/flutter_flow/` (accept generated)
- **Revert:** `git revert <hash>` or `git reset --hard origin/ALINO`
- **Commit:** Use meaningful messages; include `Fixes #issue` if applicable

## Architecture

```
Flutter App
├── Firebase Auth (auth only)
├── Supabase (database + edge functions + storage)
│   ├── users (firebase_uid link, lat/lng + PostGIS), appointments, video_call_sessions, chime_messages
│   ├── ai_conversations, ai_messages, clinical_notes, ehrbase_sync_queue
│   └── Storage: chime_storage (chat files), profile_pictures
├── AWS Chime SDK (video calls)
├── AWS Bedrock (AI chat)
└── EHRbase (OpenEHR medical records, EU-1)
```

**Roles:** Patient, Provider, Facility Admin, System Admin
**AI Models (role-based):** health (Nova Lite), clinical (Opus), operations (Nova Pro), platform (Nova Pro)

## Key Files & Locations

| Type | Path | Notes |
|------|------|-------|
| Entry | `lib/main.dart:28-42` | Critical init order |
| State | `lib/app_state.dart` | FFAppState, secure storage |
| Custom Code | `lib/custom_code/` | Actions & widgets |
| Video Call | `lib/custom_code/widgets/chime_meeting_enhanced.dart` | ~2k lines, Chime v3 |
| Join Room | `lib/custom_code/actions/join_room.dart` | ~1k lines, orchestrator |
| Firebase | `firebase/functions/index.js` | Protected by pre-commit |
| Edge Funcs | `supabase/functions/*/index.ts` | 18 standard functions |
| Migrations | `supabase/migrations/*.sql` | Never edit existing |
| Environment | `assets/environment_values/environment.json` | NOT in git; contact team |

## Cloud Functions

**Firebase (6):** onUserCreated, onUserDeleted, addFcmToken, sendPushNotificationsTrigger, sendScheduledPushNotifications, sendVideoCallNotification

**Supabase Edge (18):**
- AI/Chat: bedrock-ai-chat, send-push-notification, check-user
- Video: chime-meeting-token, chime-messaging, call-send-message, start-medical-transcription, chime-recording-callback, chime-transcription-callback
- Clinical: generate-clinical-note, chime-entity-extraction, ingest-call-transcript, finalize-call-draft, sync-to-ehrbase
- Storage: storage-sign-url, upload-profile-picture, cleanup-old-profile-pictures, cleanup-expired-recordings

## Edge Function Authentication

All edge functions use Firebase tokens (not Supabase sessions):
1. Extract token from `x-firebase-token` header (lowercase)
2. Verify with `verifyFirebaseJWT()` shared utility
3. Extract `userId` from decoded token
4. Query Supabase Admin Client (service role key, bypasses RLS)
5. Return structured response with `error`, `code`, `status`

```typescript
const token = req.headers['x-firebase-token'];
const auth = await verifyFirebaseJWT(token);
if (!auth.valid) return { error: 'Unauthorized', code: 'INVALID_FIREBASE_TOKEN', status: 401 };
const result = await supabaseAdminClient.from('table').select().eq('user_id', auth.userId);
return { success: true, data: result, status: 200 };
```

## Custom Code Overview

**Core Actions:**
- **joinRoom** (~1k lines): 3-stage orchestrator (pre-call assessment → video → post-call)
  - Enforce provider-only creation
  - Fetch patient biometrics & existing SOAP notes
  - Force-refresh Firebase token before edge function call
  - 3-retry exponential backoff
  - Async transcription job initiation
- **sendBedrockMessage**: Role-based AI, conversation history, language detection, token tracking
- **finalizeVideoCall**: Stop transcription, build speaker map, initiate Transcribe job, generate SOAP, mark finalized
- Location helpers: updateUserLocation, getNearby* (50km radius), calculateDistanceKm (Haversine)

**Widgets:**
- **ChimeMeetingEnhanced** (~2k lines): Chime v3 via InAppWebView, 1-16 participants, active speaker, live captions (fade timers), transcript buffering (12-sec intervals), file attachments, web support, network quality
- ChimePreJoiningDialog, PostCallClinicalNotesDialog, ActivityDetector, PatientHistoryDialog, CountryPhonePicker

## Important Code Patterns

```dart
// Global state
FFAppState().update(() { FFAppState().UserRole = 'patient'; });

// Supabase query
final user = await SupaFlow.client.from('users').select().eq('id', id).single();

// Firebase token (CRITICAL: always force-refresh)
final token = await FirebaseAuth.instance.currentUser?.getIdToken(true);

// Call edge function with Firebase token
final response = await http.post(
  Uri.parse('$supabaseUrl/functions/v1/chime-meeting-token'),
  headers: {
    'apikey': supabaseAnonKey,
    'Authorization': 'Bearer $supabaseAnonKey',
    'x-firebase-token': token,  // lowercase!
    'Content-Type': 'application/json',
  },
  body: jsonEncode(requestBody),
);

// Exponential backoff retry
int retries = 0;
while (retries < 3) {
  try { final r = await http.post(...); if (r.statusCode == 200) break; }
  catch (e) { retries++; await Future.delayed(Duration(seconds: pow(2, retries).toInt())); }
}

// Error handling
final json = jsonDecode(response.body);
if (json['code'] == 'PATIENT_CANNOT_CREATE') showErrorDialog('Only providers can initiate calls');
```

## Video Call Workflow (joinRoom)

**1. Pre-Call Assessment (provider only):**
- Show ChimePreJoiningDialog for permissions
- Fetch patient biometrics & existing SOAP notes
- Provider reviews context

**2. Video Execution:**
- Force-refresh Firebase token: `getIdToken(true)`
- Call chime-meeting-token edge function (3-retry backoff)
- Initialize Chime SDK from CDN
- Create/join meeting, stream to chime_messages
- Pause session timeout during call

**3. Post-Call Workflow:**
- Stop transcription capture
- Show PostCallClinicalNotesDialog (AI auto-populated)
- Provider reviews & signs
- Async AWS Transcribe Medical job
- Sync to EHRbase

## Real-Time Transcription

- Segments accumulate in StringBuffer (prevent bloat)
- Process every 12 seconds (configurable)
- Prevent concurrent processing with `_isProcessingTranscript` flag
- Track processed IDs (500-msg limit)
- Caption text fades after 3-5 sec

## Database Tables Summary

**Users/Profiles:** users (firebase_uid, lat/lng + PostGIS), patient_profiles, medical_provider_profiles, facility_admin_profiles, system_admin_profiles, facilities

**Appointments/Calls:** appointments, video_call_sessions, chime_messages, call_notifications, transcription_usage_daily

**AI/Clinical:** ai_assistants, ai_conversations, ai_messages, clinical_notes, ehrbase_sync_queue

**Pharmacy:** pharmacy_products, pharmacy_inventory, user_cart, user_wishlist, user_addresses, pharmacy_orders, pharmacy_order_items, product_reviews, order_tracking, pharmacy_coupons, coupon_usage

**Other:** active_sessions, language_preferences, custom_vocabularies, Storage: chime_storage, profile_pictures

## Error Codes

- **401 INVALID_FIREBASE_TOKEN**: Token invalid/expired/malformed
- **403 PATIENT_CANNOT_CREATE**: Patients can't initiate calls
- **403 INSUFFICIENT_PERMISSIONS**: Lacks role/authorization
- **404 NO_ACTIVE_CALL**: Meeting doesn't exist/inactive
- **410 MEETING_EXPIRED**: Meeting ended/finalized
- **503 TRANSCRIPTION_NOT_AVAILABLE**: AWS Transcribe unavailable

## AI & LLM Integration

**Providers:** OpenAI, Google GenAI (Gemini), Anthropic (Claude), AWS Bedrock

**Patterns:** Sequential chains (transcription → SOAP), conversation chains with memory, document loaders (EHRbase), output parsers (structured extraction)

**Firebase Functions:** Use LangChain for orchestrating Firebase/Supabase/AWS workflows

## Payment Processing

**Providers:** Stripe (cards), Braintree (PayPal/cards), Razorpay (India)

**Flow:** Add to user_cart → create order → webhook confirms → mark paid → reserve stock → track order

**Config:** Store credentials in Firebase config (never hardcode)

## Pharmacy E-Commerce (Jan 13, 2026)

**Actions:** calculateCartTotal, validateCouponCode, checkProductStock, reserveProductStock, getNearbyPharmacies

**Views:** product_catalog_view, low_stock_products, expired_products, top_selling_products, user_cart_with_details, pharmacy_orders_with_details

**Test:** `./test_all_systems.sh` or `verify_pharmacy_system.js`

## Development Workflows

**Start Session:**
```bash
nvm use 20 && flutter pub get && cd firebase/functions && npm install && cd ../..
npx supabase link --project-ref noaeltglphdlkbflipit
flutter run -d chrome
npx supabase functions logs [name] --tail  # in another terminal
```

**Add Edge Function:**
1. Create `supabase/functions/[name]/index.ts`
2. Add to `supabase/functions/_shared/` if needed
3. Deploy: `npx supabase functions deploy [name]`
4. View logs: `npx supabase functions logs [name] --tail`

**Modify Schema:**
1. Create new migration: `supabase/migrations/YYYYMMDDHHMMSS_description.sql`
2. Test locally: `npx supabase db reset`
3. Deploy: `npx supabase db push`

## Environment & Versions

**Check:** `node --version` (20.x), `flutter --version` (>=3.0.0 <4.0.0), `firebase --version`, `npm --version`

**Never commit:** `.env`, `credentials.json`, `environment.json`, service keys, `node_modules/`, `build/`, `.dart_tool/`

## Helper Scripts

**Testing:** test_all_systems.sh, test_user_creation_flow.sh, test_video_call_web_automated.sh, test_role_based_ai_models_complete.sh

**Mobile:** fix_emulator_camera.sh, test_android_video_fix.sh, test_video_call_android_automated.sh

**Clinical:** test_clinical_note_workflow.sh, test_transcription_automated.sh, test_ehr_sync_complete.sh

**Database:** check_schema.sh, verify_appointments.sh, update_appointments_to_today.sh

**Verification:** validate-critical-functions.sh, verify_onusercreated.sh, verify_flutterflow_cleanup.sh

**Deployment:** deploy_specialty_tables.sh, setup-automated-backups.sh, test-phase1-security.sh

## Performance Tips

- **Profile:** `flutter run -d chrome --profile` → DevTools Performance
- **Slow queries:** Use `pg_stat_statements`; add indexes on user_id, firebase_uid, appointment_id
- **Transcription:** 2-10 min; show progress UI, don't block
- **Chime SDK:** Loads from CloudFront; pre-cache or use service worker
- **Realtime:** Avoid subscribing to large tables; use filters
- **Queries:** Batch instead of N+1 loops

## External Resources

- [Flutter](https://flutter.dev/docs) | [Supabase](https://supabase.com/docs) | [Firebase](https://firebase.google.com/docs) | [AWS Chime SDK](https://docs.aws.amazon.com/chime-sdk/) | [AWS Bedrock](https://docs.aws.amazon.com/bedrock/)

## Session Security

- Single-device login via `active_device_id`
- 5-min inactivity timeout (paused during calls)
- Force logout on new device
