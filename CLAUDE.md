# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

MedZen is a healthcare platform built with FlutterFlow, Firebase Auth, Supabase, EHRbase (OpenEHR), AWS Chime SDK, and AWS Bedrock.

## Quick Reference

| Action | Command |
|--------|---------|
| Clean build | `flutter clean && flutter pub get` |
| Run web | `flutter run -d chrome` |
| Run Android | `flutter run -d android` |
| Run iOS | `flutter run -d ios` |
| Build APK | `flutter build apk --release` |
| Build iOS | `flutter build ios --release` |
| Build Web | `flutter build web` |
| Deploy Supabase (all) | `npx supabase functions deploy bedrock-ai-chat check-user chime-meeting-token chime-messaging send-push-notification sync-to-ehrbase generate-clinical-note start-medical-transcription chime-recording-callback chime-transcription-callback chime-entity-extraction cleanup-expired-recordings ingest-call-transcript finalize-call-draft storage-sign-url call-send-message upload-profile-picture cleanup-old-profile-pictures` |
| Deploy single edge fn | `npx supabase functions deploy <function-name>` |
| Deploy Firebase | `firebase deploy --only functions` |
| Test all systems | `./test_all_systems.sh` |
| View Firebase logs | `firebase functions:log --limit 50` |
| View Supabase logs | `npx supabase functions logs [name] --tail` |
| Link Supabase | `npx supabase link --project-ref noaeltglphdlkbflipit` |
| Analyze code | `dart analyze lib/` |
| Test edge function | `curl -X POST "$URL/functions/v1/[name]" -H "apikey: $KEY" -H "Authorization: Bearer $KEY" -H "Content-Type: application/json" -d '{}'` |
| Run emulator | `flutter run -d emulator-5554` |
| Firebase emulator | `cd firebase/functions && npm run serve` |
| Firebase lint | `cd firebase/functions && npm run lint` |
| List emulators | `emulator -list-avds` |
| iOS pod fix | `cd ios && pod deintegrate && pod install` |

## Critical IDs
- Firebase: `medzen-bf20e`
- Supabase: `noaeltglphdlkbflipit`
- AWS Region: `eu-central-1` (primary)
- Supabase Pooler: `aws-0-eu-central-1.pooler.supabase.com:6543`
- Node version: 20 (for Firebase functions)
- Flutter SDK: >=3.0.0 <4.0.0
- Supabase Realtime: Real-time subscriptions enabled for chat and notifications
- Main branch for PRs: `ALINO`

## Non-Negotiable Rules

### 1. Initialization Order (CRITICAL)
In `lib/main.dart:28-42` MUST follow: Environment → Firebase → Supabase → Localizations → AppState → initializeMessaging()

### 2. FlutterFlow Files
NEVER modify `lib/flutter_flow/` - auto-generated by FlutterFlow. NEVER remove unused imports from FlutterFlow-generated files.

### 2a. Analyzer Warnings
The codebase has ~10k analyzer warnings (unused imports, const suggestions, etc.) mostly from FlutterFlow-generated code. These are EXPECTED and should NOT be fixed. Only fix actual compilation errors.

### 3. Firebase Auth + Supabase Pattern
This app uses Firebase Auth but stores data in Supabase. Users are linked via `firebase_uid` column:
```dart
final user = await SupaFlow.client.from('users').select().eq('firebase_uid', firebaseUid).single();
```

### 4. RLS Policies for Firebase Auth
Firebase tokens don't create Supabase sessions, so RLS must allow `auth.uid() IS NULL`:
```sql
CREATE POLICY "name" ON table FOR SELECT USING (auth.uid() IS NULL OR user_id = auth.uid());
```

### 5. Video Calls - AWS Chime SDK v3.19.0
- Widget: `lib/custom_code/widgets/chime_meeting_enhanced.dart`
- Action: `lib/custom_code/actions/join_room.dart`
- CDN: `https://du6iimxem4mh7.cloudfront.net/assets/amazon-chime-sdk-medzen.min.js`
- Edge function: `supabase/functions/chime-meeting-token/index.ts`
- Provider-only meeting creation; patients join via `appointmentId`
- Pass Firebase token in `x-firebase-token` header (lowercase)
- **v3 API Breaking Change**: Use `startVideoInput()` NOT `chooseVideoInputDevice()` (deprecated in v3)

### 6. Edge Functions and Firebase Token
Edge functions verify Firebase tokens internally. Use HTTP directly, not `SupaFlow.client.functions.invoke()`:
```dart
final response = await http.post(
  Uri.parse('$supabaseUrl/functions/v1/chime-meeting-token'),
  headers: {
    'apikey': supabaseAnonKey,
    'Authorization': 'Bearer $supabaseAnonKey',
    'x-firebase-token': firebaseJwt,  // lowercase header name
  },
  body: jsonEncode(requestBody),
);
```

### 7. Database Migrations
NEVER edit existing migrations. Create new: `supabase/migrations/YYYYMMDDHHMMSS_description.sql`

### 8. UUID Handling
NEVER cast to TEXT. Use native UUID: `id` not `id::text`

### 9. Image URLs
Must start with `http://` or `https://`. Database constraints enforce this.

### 10. Firebase Configuration
NEVER hardcode credentials. Use `firebase functions:config:set` only.

### 11. Git Pre-commit Hook
A pre-commit hook (`.git/hooks/pre-commit`) protects critical Firebase functions from accidental deletion:
- Verifies `onUserCreated`, `onUserDeleted`, `addFcmToken`, `sendPushNotificationsTrigger`, `sendVideoCallNotification` exist
- Only runs checks when `firebase/functions/index.js` is staged for commit
- Blocks commits if any critical function is missing

## Architecture

```
Flutter App
    │
    ├── Firebase Auth (authentication only)
    │
    ├── Supabase (database + edge functions)
    │   ├── users table (firebase_uid links to Firebase)
    │   ├── appointments, video_call_sessions, chime_messages
    │   └── ai_conversations, ai_messages
    │
    ├── AWS Chime SDK (video calls via edge function → AWS Lambda)
    │
    ├── AWS Bedrock (AI chat via edge function)
    │
    └── EHRbase (OpenEHR medical records)
```

**User Roles:** Patient, Provider (Medical), Facility Admin, System Admin

**AI Assistants (role-based in `ai_assistants` table):**
- `health` - Patients (Claude 3.5 Sonnet / Nova Pro)
- `clinical` - Providers (Claude 3.7 Sonnet)
- `operations` - Facility Admins
- `platform` - System Admins

## Key File Locations

| Type | Path |
|------|------|
| App Entry | `lib/main.dart` |
| App State | `lib/app_state.dart` |
| Custom Actions | `lib/custom_code/actions/` |
| Custom Widgets | `lib/custom_code/widgets/` |
| Video Call Widget | `lib/custom_code/widgets/chime_meeting_enhanced.dart` |
| Supabase Config | `lib/backend/supabase/supabase.dart` |
| Firebase Functions | `firebase/functions/index.js` |
| Edge Functions | `supabase/functions/*/index.ts` |
| Migrations | `supabase/migrations/*.sql` |
| Environment | `assets/environment_values/environment.json` |

## Cloud Functions

**Firebase (`firebase/functions/index.js`):**
- `addFcmToken` - Register device FCM token to Firestore
- `onUserDeleted` - Cleanup Firestore user doc on Firebase Auth deletion
- `sendPushNotificationsTrigger` - Send FCM on Firestore `ff_push_notifications` doc create
- `sendScheduledPushNotifications` - Cron job (every 60 min) for scheduled notifications

**Supabase Edge Functions (`supabase/functions/*/index.ts`):**

*Core Functions:*
- `bedrock-ai-chat` - AI assistant with role-based models via AWS Bedrock
- `check-user` - Verify user exists by Firebase UID
- `send-push-notification` - FCM push notifications via Firebase Admin SDK
- `sync-to-ehrbase` - Medical data sync to OpenEHR/EHRbase

*Video Call Functions:*
- `chime-meeting-token` - Create/join video meetings via AWS Chime
- `chime-messaging` - Real-time chat during video calls
- `call-send-message` - Send message during active call
- `start-medical-transcription` - Start AWS Transcribe Medical for video calls
- `chime-recording-callback` - Handle S3 recording uploads
- `chime-transcription-callback` - Handle transcription completion
- `cleanup-expired-recordings` - Remove old video recordings from S3

*Clinical Notes Functions:*
- `generate-clinical-note` - AI clinical note generation from transcripts
- `chime-entity-extraction` - Extract medical entities (ICD-10/CPT) from transcripts
- `ingest-call-transcript` - Ingest and process video call transcript
- `finalize-call-draft` - Finalize clinical note draft after provider review

*Storage Functions:*
- `storage-sign-url` - Generate signed URLs for secure file access
- `upload-profile-picture` - Handle profile picture uploads to storage
- `cleanup-old-profile-pictures` - Remove orphaned profile pictures

*PowerSync Functions (offline-first sync - not in standard deploy):*
- `powersync-token` - Generate PowerSync authentication tokens
- `refresh-powersync-views` - Refresh PowerSync materialized views

**Note:** Edge functions prefixed with `test-` or ending in `-test`/`-test-auth` are for development testing only and should not be deployed to production. PowerSync functions are deployed separately when needed: `npx supabase functions deploy powersync-token refresh-powersync-views`

## Custom Code

**Actions (`lib/custom_code/actions/`):**
- `joinRoom` (`join_room.dart`) - Navigate to video call with Chime SDK
- `sendBedrockMessage` (`send_bedrock_message.dart`) - Send message to AI assistant
- `createAIConversation` (`create_a_i_conversation.dart`) - Create new AI chat session
- `detectUserRole` - Determine user role from Supabase
- `getAssistantByType` - Get AI assistant config by role
- `buildConversationHistory` - Build message history for AI context
- `initializeMessaging` - Initialize FCM push notifications
- `initializeSessionTracking` - Setup device session tracking
- `streamResponse` - Stream AI responses
- `generatePostCallSummary` - Generate clinical note from video call transcript
- `signClinicalNote` - Sign clinical note and sync to OpenEHR
- `syncClinicalNoteToOpenehr` - Sync signed clinical note to EHRbase
- `getClinicalNotes` - Retrieve clinical notes for patient/provider
- `getTranscriptStatus` - Check transcription status of a video call
- `generateClinicalNote` - Direct clinical note generation
- `controlMedicalTranscription` - Start/stop medical transcription

**Location Actions (PostGIS-based):**
- `getNearbyFacilities` - Find facilities near given lat/lng coordinates
- `getNearbyFacilitiesForUser` - Find facilities near a user's stored location
- `getNearbyProviders` - Find medical providers near given coordinates
- `getNearbyPatients` - Find patients near given coordinates (for providers)
- `getNearbyBloodDonors` - Find blood donors near given coordinates
- `getNearbyPlaces` - General nearby places search via Google Places API
- `updateUserLocation` - Update user's lat/lng in the database
- `getUserLastLocation` - Get user's last stored location
- `calculateDistanceKm` - Calculate distance between two points using Haversine formula

**Widgets (`lib/custom_code/widgets/`):**
- `ChimeMeetingEnhanced` - AWS Chime video call WebView
- `ChimePreJoiningDialog` - Pre-call dialog for camera/mic permissions check
- `ActivityDetector` - User inactivity detection (pauses during video calls)
- `CountryPhonePicker` - International phone number input

## Important Patterns

```dart
// Global state updates
FFAppState().update(() {
  FFAppState().UserRole = 'patient';
});

// Supabase query
final result = await SupaFlow.client.from('users').select().eq('id', id).single();

// Force-refresh Firebase token before API calls
final userToken = await FirebaseAuth.instance.currentUser?.getIdToken(true);

// Video call navigation
await joinRoom(context, sessionId, providerId, patientId, appointmentId, isProvider, userName, profileImage, providerName, providerRole);
```

## Session Security
- Single-device login enforced via `users.active_device_id` and `users.active_session_token`
- 5-min inactivity timeout (paused during video calls via `ActivityDetector` widget)
- Force logout via FCM push notification when new device logs in
- Session tracking via `active_sessions` table with `is_video_call_active` flag

## Video Call Data Flow
```
1. Provider initiates call → joinRoom() action
2. Action calls chime-meeting-token edge function with x-firebase-token header
3. Edge function creates Chime meeting via AWS Lambda, stores in video_call_sessions
4. ChimeMeetingEnhanced widget loads SDK from CloudFront CDN
5. WebView connects to Chime meeting
6. Optional: start-medical-transcription enables AWS Transcribe Medical
7. Chat messages stored in chime_messages table (appointment_id based)
8. On call end: transcript available in video_call_sessions.transcript
```

**Chime SDK v3 Method Reference:**
| v2 (Deprecated) | v3 (Current) |
|-----------------|--------------|
| `chooseVideoInputDevice()` | `startVideoInput()` |
| `chooseAudioInputDevice()` | `startAudioInput()` |
| `chooseAudioOutputDevice()` | Direct property set |

## AI Chat Data Flow
```
1. User sends message → sendBedrockMessage() action
2. Action determines user role via detectUserRole()
3. Gets appropriate AI assistant config from ai_assistants table
4. Calls bedrock-ai-chat edge function with conversation history
5. Edge function routes to AWS Bedrock with role-specific model
6. Response stored in ai_messages, conversation updated in ai_conversations
```

## Clinical Notes Workflow
After a video call with transcription enabled:
1. `generatePostCallSummary()` checks transcription status and generates clinical note
2. Provider reviews the AI-generated SOAP note
3. `signAndSyncClinicalNote()` signs the note and queues OpenEHR sync
4. Background job syncs to EHRbase via `sync-to-ehrbase` edge function

Key tables: `clinical_notes`, `ehrbase_sync_queue`, `video_call_sessions`

## Database Tables

**Core Tables:**
| Table | Purpose |
|-------|---------|
| `users` | User profiles (links via `firebase_uid`) |
| `patient_profiles` | Extended patient information |
| `medical_provider_profiles` | Provider credentials, specialties |
| `facility_admin_profiles` | Facility administrator details |
| `system_admin_profiles` | System admin details |
| `facilities` | Healthcare facilities with PostGIS location |
| `specialties` | Medical specialties reference |

**Appointments & Video Calls:**
| Table | Purpose |
|-------|---------|
| `appointments` | Scheduled appointments |
| `appointment_overview` | View with patient/provider details |
| `video_call_sessions` | Call records with Chime meeting data |
| `chime_messages` | Chat messages during video calls |
| `live_caption_segments` | Real-time transcription segments |

**AI & Clinical:**
| Table | Purpose |
|-------|---------|
| `ai_assistants` | AI model configs per role |
| `ai_conversations` | AI chat sessions |
| `ai_messages` | Individual AI chat messages |
| `clinical_notes` | AI-generated notes from video calls |
| `ehrbase_sync_queue` | OpenEHR sync queue |

**Session & Language:**
| Table | Purpose |
|-------|---------|
| `active_sessions` | Device session tracking |
| `language_preferences` | User language settings |
| `custom_vocabularies` | Medical vocabulary for transcription |

## Supported Languages
English (en), French (fr), Afrikaans (af), Arabic (ar)

## Common Issues

| Problem | Solution |
|---------|----------|
| App won't build | `flutter clean && flutter pub get` |
| Video blank screen | Check permissions, Firebase auth, browser console for CDN/SDK errors |
| Video camera not working | Use `startVideoInput()` not `chooseVideoInputDevice()` (Chime SDK v3 API change) |
| Edge function 401 | Ensure `x-firebase-token` header is lowercase, call `getIdToken(true)` to refresh |
| Edge function 500 | Check `npx supabase functions logs <name> --tail` for stack trace |
| Firebase function fails | `firebase functions:config:get` to check env vars are set |
| RLS blocking queries | Ensure policy allows `auth.uid() IS NULL` for Firebase auth pattern |
| EHR sync failing | Check `ehrbase_sync_queue` table for error messages |
| Emulator camera | `./fix_emulator_camera.sh` or enable webcam passthrough in AVD |
| iOS pod issues | `cd ios && pod deintegrate && pod install` |
| Analyzer 10k issues | Normal - FlutterFlow-generated warnings, verify build works |
| @override error | Method not in base class - remove annotation or check parent |
| Supabase connection | Ensure `npx supabase link --project-ref noaeltglphdlkbflipit` was run |

## Environment Configuration
Environment values loaded from `assets/environment_values/environment.json` via `FFDevEnvironmentValues()`:
- `SupaBaseURL` - Supabase project URL
- `Supabasekey` - Supabase anon key (client-safe)
- Payment API keys (PayU)
- AWS API endpoints (SMS, OTP, password reset)

## Testing Edge Functions
```bash
KEY="<service_role_key>"
URL="https://noaeltglphdlkbflipit.supabase.co"
curl -X POST "$URL/functions/v1/bedrock-ai-chat" \
  -H "apikey: $KEY" \
  -H "Authorization: Bearer $KEY" \
  -H "Content-Type: application/json" \
  -d '{"message":"test"}'
```

## Database Queries
```bash
# Direct psql connection (replace <password>)
PGPASSWORD='<password>' psql "postgresql://postgres.noaeltglphdlkbflipit:@aws-0-eu-central-1.pooler.supabase.com:6543/postgres"

# Check RLS policies
SELECT policyname, tablename, cmd FROM pg_policies WHERE schemaname = 'public';

# Check table columns
SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'users';

# Check failed EHR syncs
SELECT * FROM ehrbase_sync_queue WHERE sync_status = 'failed' ORDER BY created_at DESC LIMIT 10;

# View RLS-enabled tables
SELECT tablename, rowsecurity FROM pg_tables WHERE schemaname = 'public' AND rowsecurity = true;
```

## Test Scripts
The repository contains many test scripts in the root directory:
- `test_all_systems.sh` - Comprehensive system check (edge functions, tables, AI assistants)
- `test_video_call_*.sh` - Video call and Chime SDK tests
- `test_ai_chat_e2e.sh` - End-to-end AI chat tests
- `test_clinical_note_workflow.sh` - Clinical notes and EHR sync tests
- `test_realtime_chat.sh` - Real-time messaging tests

AWS deployment scripts are in `aws-deployment/`:
- `00-prerequisites.sh` through `07-setup-monitoring.sh` - Full deployment pipeline
- `scripts/validate-deployment.sh` - Validation checks

**Note:** Test scripts may contain service role keys for testing. These scripts are for local development only.

## Never Commit
- `.env` files, `.runtimeconfig.json`
- `firebase-adminsdk-*.json`, any `*credentials*.json`
- `assets/environment_values/environment.json`
- Service role keys or any API secrets
- Test scripts with hardcoded credentials (sanitize before committing)
