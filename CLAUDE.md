# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

Healthcare platform: FlutterFlow + Firebase Auth + Supabase + EHRbase + AWS Chime SDK + AWS Bedrock

## Quick Commands

### Development
| Action | Command |
|--------|---------|
| Clean & run web | `flutter clean && flutter pub get && flutter run -d chrome` |
| Run Android | `flutter run -d android` |
| Run iOS | `flutter run -d ios` |
| Run with profiling | `flutter run -d chrome --profile` |
| Analyze code | `dart analyze lib/ --fatal-infos --fatal-warnings` |

### Testing
| Action | Command |
|--------|---------|
| Run all Flutter tests | `flutter test` |
| Run comprehensive tests | `./test_all_systems.sh` |
| Test video calls (web) | `./test_video_call_web_automated.sh` |
| Test AI chat | `./test_role_based_ai_models_complete.sh` |
| Test transcription | `./test_transcription_automated.sh` |
| Test E2E AI chat | `./test_ai_chat_e2e.sh` |

### Deployment & Cloud Functions
| Action | Command |
|--------|---------|
| Deploy all Supabase functions | `npx supabase functions deploy bedrock-ai-chat check-user chime-meeting-token chime-messaging send-push-notification sync-to-ehrbase generate-clinical-note start-medical-transcription chime-recording-callback chime-transcription-callback chime-entity-extraction cleanup-expired-recordings ingest-call-transcript finalize-call-draft storage-sign-url call-send-message upload-profile-picture cleanup-old-profile-pictures` |
| Deploy single function | `npx supabase functions deploy [function-name]` |
| Firebase emulator | `cd firebase/functions && npm run serve` |
| Firebase linting | `npm run lint` (from firebase/functions) |
| Watch Supabase logs | `npx supabase functions logs [name] --tail --follow` |
| View Firebase logs | `firebase functions:log --limit 50` |

### Database
| Action | Command |
|--------|---------|
| Reset local Supabase | `npx supabase db reset` |
| Push migrations | `npx supabase db push` |
| Check schema | `./check_schema.sh` |

## Critical IDs & Versions

- **Firebase:** `medzen-bf20e` | **Supabase:** `noaeltglphdlkbflipit` | **AWS Region:** `eu-central-1`
- **Node.js:** 20.x | **Flutter:** >=3.0.0 <4.0.0 | **Chime SDK:** v3.19.0
- **Main PR Branch:** `ALINO` (NOT main) | **Supabase Pooler:** `aws-0-eu-central-1.pooler.supabase.com:6543`

## Non-Negotiable Rules

1. **Initialization Order** (`lib/main.dart:28-42`): Environment → Firebase → Supabase → Localizations → AppState → initializeMessaging()
2. **Never modify** `lib/flutter_flow/` (auto-generated by FlutterFlow). Analyzer warnings (~10k) are expected; ignore unused imports.
3. **Firebase Auth + Supabase Pattern:** Firebase-only auth; data stored in Supabase via `firebase_uid` column
4. **RLS Policies:** Must allow `auth.uid() IS NULL` for Firebase tokens (no Supabase session)
5. **Video Calls (Chime SDK v3):** Use `startVideoInput()`/`startAudioInput()` (v2 APIs deprecated)
   - Widget: `lib/custom_code/widgets/chime_meeting_enhanced.dart`
   - Action: `lib/custom_code/actions/join_room.dart`
   - CDN: `https://du6iimxem4mh7.cloudfront.net/assets/amazon-chime-sdk-medzen.min.js`
   - Provider-only creation; patients join via `appointmentId`
6. **Edge Functions:** Use HTTP (not `SupaFlow.client.functions.invoke()`); pass Firebase token in lowercase `x-firebase-token` header
7. **Migrations:** Never edit existing; create new: `supabase/migrations/YYYYMMDDHHMMSS_description.sql`
8. **UUIDs:** Never cast to TEXT; use native UUID
9. **Firebase Config:** Never hardcode credentials
10. **Pre-commit Hook** (`.git/hooks/pre-commit`): Protects critical Firebase functions. If fails: restore from git history
11. **PostGIS:** Use `updateUserLocation()`, `getNearby*()` (50km radius), `calculateDistanceKm()` (Haversine)
12. **FlutterFlow Conflicts:** Accept generated version; re-apply custom logic in `lib/custom_code/`

## FlutterFlow Integration Notes

- **Structure:** Pages auto-generated in `lib/` root; custom code stays in `lib/custom_code/` (never modified by FlutterFlow)
- **When pushing to FlutterFlow:** Changes must go through UI editor; direct file edits in `lib/flutter_flow/` will be overwritten
- **Conflict resolution:** `git checkout --theirs lib/flutter_flow/ && git add lib/flutter_flow/` to accept generated version, then re-apply any custom logic in `lib/custom_code/`
- **Custom actions available:** Located in `lib/custom_code/actions/` and accessible from FlutterFlow UI via custom action picker
- **Custom widgets available:** Located in `lib/custom_code/widgets/` and accessible from FlutterFlow UI via custom widget picker
- **Key files never regenerated:** `lib/main.dart`, `lib/app_state.dart`, `lib/index.dart`, `lib/auth/`

## Environment Setup

### Initial Setup
```bash
git clone <repo> && cd medzen-iwani-t1nrnu && nvm use 20
flutter pub get && cd firebase/functions && npm install && cd ../..
npx supabase link --project-ref noaeltglphdlkbflipit
# Copy environment.json from team (NOT in git for security reasons)
flutter devices && npx supabase status && node --version
```

### Required Environment File
- **Location:** `assets/environment_values/environment.json`
- **Status:** Gitignored (contains sensitive credentials)
- **Action:** Request from team; never commit
- **Contents:** Firebase API keys, Supabase anon key, EHRbase URL, etc.

### Verify Setup
```bash
dart --version                    # >=2.17
flutter --version                 # >=3.0.0 <4.0.0
node --version                    # 20.x
firebase --version
npx supabase --version
```

### Troubleshooting Setup Issues
| Issue | Fix |
|-------|-----|
| Supabase not linked | `npx supabase link --project-ref noaeltglphdlkbflipit` |
| Pod resolution errors (iOS) | `cd ios && pod deintegrate && pod install && cd ..` |
| Flutter pub issues | `flutter clean && flutter pub get` |
| Dart analysis failing | Check `.dart_tool/` exists; if not, run `flutter pub get` again |
| Firebase emulator won't start | Ensure Node 20: `nvm use 20 && cd firebase/functions && npm run serve` |

## Mobile Development

**Android:** `flutter emulators launch emulator-5554 && flutter run -d emulator-5554` | Camera issues: `./fix_emulator_camera.sh`
**iOS:** `open -a Simulator && flutter run -d "iPhone 15"` | Pods: `cd ios && pod deintegrate && pod install`
**Permissions:** CAMERA, RECORD_AUDIO, ACCESS_FINE_LOCATION, INTERNET (Android) | NSCameraUsageDescription, NSMicrophoneUsageDescription, NSLocationWhenInUseUsageDescription (iOS)

## Testing

```bash
flutter test                          # Unit/widget tests
./test_all_systems.sh                # Comprehensive
./test_video_call_web_automated.sh   # Video calls
./test_role_based_ai_models_complete.sh  # AI chat
npx supabase db reset                # Reset migrations
```

## Debugging Quick Reference

| Issue | Fix |
|-------|-----|
| **401 INVALID_FIREBASE_TOKEN** | Header must be lowercase `x-firebase-token`. Call `getIdToken(true)` to force-refresh. |
| **403 PATIENT_CANNOT_CREATE** | Patients can't initiate calls. Only providers create meetings. Check `isProvider` param. |
| **404 NO_ACTIVE_CALL** | Meeting doesn't exist or inactive. Verify `sessionId` in `video_call_sessions`. |
| **410 MEETING_EXPIRED** | Meeting ended. Check `ended_at` timestamp in `video_call_sessions`. |
| **500** | Check logs: `npx supabase functions logs <name> --tail`. Verify env vars, AWS creds. |
| **Video blank** | Browser console: verify Chime SDK CDN loads. Check `startVideoInput()` called (not v2 API). |
| **RLS blocking** | Policy must allow `auth.uid() IS NULL OR user_id = auth.uid()`. Verify `firebase_uid` link. |
| **Transcription stuck** | Check `transcription_usage_daily` for AWS limits. Verify status in `video_call_sessions`. |
| **Live captions missing** | Check `_isProcessingTranscript` flag. Verify buffer accumulating. Check 12-sec timer. |
| **Tab 2 Missing Fields** | Run test query: `SELECT COUNT(*) FROM clinical_notes WHERE soap_data->'tab2_patient_identification'->'phone' IS NULL;` If count >0, verify create-context-snapshot deployed and context snapshots have user_profiles data. Check logs: `npx supabase functions logs generate-soap-draft-v2 --tail` for "Tab 2 missing" warnings. May need to re-run context snapshot creation to populate missing address/emergency_contact fields. |
| **SOAP not populating** | Verify transcript in `call_transcripts`. Check `generate-soap-from-context` logs. |
| **Build fails** | `flutter clean && flutter pub get` |
| **iOS pods fail** | `cd ios && pod deintegrate && pod install` |

**Debug tools:** `flutter run -v` (verbose) | `flutter run -d chrome --profile` (profile) | Browser DevTools: `Ctrl+Shift+I`

## Common Development Tasks

### Adding a New Custom Action
1. Create file in `lib/custom_code/actions/my_action.dart`
2. Implement function and export in `lib/custom_code/actions/index.dart`
3. Import in page: `import '/custom_code/actions/index.dart' as actions;`
4. Call from FlutterFlow: Select "Custom Action" → choose your action
5. For edge function calls: follow the Firebase token + retry pattern in existing actions

### Adding a New Custom Widget
1. Create file in `lib/custom_code/widgets/my_widget.dart`
2. Extend `StatefulWidget` or `StatelessWidget`
3. Export in `lib/custom_code/widgets/index.dart`
4. In FlutterFlow: Add Custom Widget → select from list
5. Configure properties via widget parameters

### Calling Supabase Edge Functions from Dart
```dart
final token = await FirebaseAuth.instance.currentUser?.getIdToken(true);
final response = await http.post(
  Uri.parse('https://noaeltglphdlkbflipit.supabase.co/functions/v1/function-name'),
  headers: {
    'apikey': supabaseAnonKey,
    'Authorization': 'Bearer $supabaseAnonKey',
    'x-firebase-token': token,  // ← lowercase!
    'Content-Type': 'application/json',
  },
  body: jsonEncode({'param': 'value'}),
);
```

### Adding a Supabase Table
1. Create migration: `supabase/migrations/20260118120000_add_my_table.sql`
2. Run locally: `npx supabase db reset`
3. Push: `npx supabase db push`
4. Schema auto-syncs to `lib/backend/schema/` on next `flutter pub get`

### Adding a New Edge Function
1. Create folder: `supabase/functions/my-function/`
2. Create `index.ts` with TypeScript handler
3. Use `verifyFirebaseJWT()` for auth (from `_shared/`)
4. Deploy: `npx supabase functions deploy my-function`
5. Watch logs: `npx supabase functions logs my-function --tail`

## Git Workflow

- **Branch:** `ALINO` (main PR target, not main) | `git checkout -b feature/name ALINO`
- **Before push:** `git fetch origin ALINO && git rebase origin/ALINO && npm run lint && dart analyze lib/ --fatal-infos && flutter test`
- **FlutterFlow conflicts:** `git checkout --theirs lib/flutter_flow/ && git add lib/flutter_flow/` (accept generated)
- **Revert:** `git revert <hash>` or `git reset --hard origin/ALINO`
- **Commit:** Use meaningful messages; include `Fixes #issue` if applicable

## Architecture

```
Flutter App
├── Firebase Auth (auth only)
├── Supabase (database + edge functions + storage)
│   ├── users (firebase_uid link, lat/lng + PostGIS), appointments, video_call_sessions, chime_messages
│   ├── ai_conversations, ai_messages, clinical_notes, ehrbase_sync_queue
│   └── Storage: chime_storage (chat files), profile_pictures
├── AWS Chime SDK (video calls)
├── AWS Bedrock (AI chat)
└── EHRbase (OpenEHR medical records, EU-1)
```

**Roles:** Patient, Provider, Facility Admin, System Admin
**AI Models (role-based):** health (Nova Lite), clinical (Opus), operations (Nova Pro), platform (Nova Pro)

## Understanding the Codebase

### Directory Structure Overview
```
lib/
├── main.dart                    # App entry point (critical init order)
├── app_state.dart               # Global state management (FFAppState)
├── index.dart                   # Page/component exports
├── auth/                        # Firebase auth (never regenerated)
├── flutter_flow/                # ⚠️  FlutterFlow auto-generated (NEVER edit)
├── custom_code/                 # Custom logic (your edits here)
│   ├── actions/                 # Reusable business logic & edge function calls
│   └── widgets/                 # Custom Flutter widgets
├── backend/
│   ├── supabase/                # Supabase client & initialization
│   ├── firebase/                # Firebase config & auth utilities
│   ├── schema/                  # Data models (generated from Supabase)
│   ├── api_requests/            # HTTP client utilities
│   └── push_notifications/      # FCM setup
└── [feature folders]/           # FlutterFlow auto-generated pages by feature

supabase/
├── functions/                   # 30+ edge functions (TypeScript)
│   ├── _shared/                 # Shared utilities (Firebase JWT verification, Supabase client)
│   └── [function-name]/         # Each function in its own folder
└── migrations/                  # Database schema changes (NEVER edit existing files)

firebase/functions/
├── index.js                     # Protected by pre-commit hook (Cloud Functions)
└── node_modules/                # Dependencies
```

### Key Architectural Patterns

**State Management:** FFAppState singleton (persisted via flutter_secure_storage)
- Access: `FFAppState().propertyName` or `FFAppState().update(() { ... })`
- Persists: user role, auth data, UI preferences

**Backend Access Patterns:**
1. **Supabase Queries:** Direct `SupaFlow.client.from('table').select()...`
2. **Edge Functions:** HTTP POST with Firebase token in `x-firebase-token` header (lowercase!)
3. **Firebase Functions:** Cloud Functions triggered by auth events or called directly

**Real-time Updates:** Supabase subscriptions via `realtime()` (e.g., chime_messages during calls)

**Error Handling:** Edge functions return `{ error: string, code: string, status: number }` format

## Key Files & Locations

| Type | Path | Notes |
|------|------|-------|
| Entry | `lib/main.dart:28-42` | Critical init order |
| State | `lib/app_state.dart` | FFAppState, secure storage |
| Custom Code | `lib/custom_code/` | Actions & widgets |
| Video Call | `lib/custom_code/widgets/chime_meeting_enhanced.dart` | ~2k lines, Chime v3 |
| Join Room | `lib/custom_code/actions/join_room.dart` | ~1k lines, orchestrator |
| Firebase | `firebase/functions/index.js` | Protected by pre-commit |
| Edge Funcs | `supabase/functions/*/index.ts` | 18 standard functions |
| Migrations | `supabase/migrations/*.sql` | Never edit existing |
| Environment | `assets/environment_values/environment.json` | NOT in git; contact team |

## Cloud Functions

**Firebase (6):** onUserCreated, onUserDeleted, addFcmToken, sendPushNotificationsTrigger, sendScheduledPushNotifications, sendVideoCallNotification

**Supabase Edge (18):**
- AI/Chat: bedrock-ai-chat, send-push-notification, check-user
- Video: chime-meeting-token, chime-messaging, call-send-message, start-medical-transcription, chime-recording-callback, chime-transcription-callback
- Clinical: generate-clinical-note, chime-entity-extraction, ingest-call-transcript, finalize-call-draft, sync-to-ehrbase
- Storage: storage-sign-url, upload-profile-picture, cleanup-old-profile-pictures, cleanup-expired-recordings

## Edge Function Authentication

All edge functions use Firebase tokens (not Supabase sessions):
1. Extract token from `x-firebase-token` header (lowercase)
2. Verify with `verifyFirebaseJWT()` shared utility
3. Extract `userId` from decoded token
4. Query Supabase Admin Client (service role key, bypasses RLS)
5. Return structured response with `error`, `code`, `status`

```typescript
const token = req.headers['x-firebase-token'];
const auth = await verifyFirebaseJWT(token);
if (!auth.valid) return { error: 'Unauthorized', code: 'INVALID_FIREBASE_TOKEN', status: 401 };
const result = await supabaseAdminClient.from('table').select().eq('user_id', auth.userId);
return { success: true, data: result, status: 200 };
```

## Custom Code Overview

**Core Actions:**
- **joinRoom** (~1k lines): 3-stage orchestrator (pre-call assessment → video → post-call)
  - Enforce provider-only creation
  - Fetch patient biometrics & existing SOAP notes
  - Force-refresh Firebase token before edge function call
  - 3-retry exponential backoff
  - Async transcription job initiation
- **sendBedrockMessage**: Role-based AI, conversation history, language detection, token tracking
- **finalizeVideoCall**: Stop transcription, build speaker map, initiate Transcribe job, generate SOAP, mark finalized
- Location helpers: updateUserLocation, getNearby* (50km radius), calculateDistanceKm (Haversine)

**Widgets:**
- **ChimeMeetingEnhanced** (~2k lines): Chime v3 via InAppWebView, 1-16 participants, active speaker, live captions (fade timers), transcript buffering (12-sec intervals), file attachments, web support, network quality
- ChimePreJoiningDialog, PostCallClinicalNotesDialog, ActivityDetector, PatientHistoryDialog, CountryPhonePicker

## Important Code Patterns

```dart
// Global state
FFAppState().update(() { FFAppState().UserRole = 'patient'; });

// Supabase query
final user = await SupaFlow.client.from('users').select().eq('id', id).single();

// Firebase token (CRITICAL: always force-refresh)
final token = await FirebaseAuth.instance.currentUser?.getIdToken(true);

// Call edge function with Firebase token
final response = await http.post(
  Uri.parse('$supabaseUrl/functions/v1/chime-meeting-token'),
  headers: {
    'apikey': supabaseAnonKey,
    'Authorization': 'Bearer $supabaseAnonKey',
    'x-firebase-token': token,  // lowercase!
    'Content-Type': 'application/json',
  },
  body: jsonEncode(requestBody),
);

// Exponential backoff retry
int retries = 0;
while (retries < 3) {
  try { final r = await http.post(...); if (r.statusCode == 200) break; }
  catch (e) { retries++; await Future.delayed(Duration(seconds: pow(2, retries).toInt())); }
}

// Error handling
final json = jsonDecode(response.body);
if (json['code'] == 'PATIENT_CANNOT_CREATE') showErrorDialog('Only providers can initiate calls');
```

## Enhanced Video Call Data Gathering Workflow

### Architecture Overview

The enhanced workflow uses a **three-tier query pattern** to gather complete patient data from denormalized database views:

1. **Tier 1: appointment_overview view** - Primary truth source (denormalized appointment + patient + provider)
2. **Tier 2: user_profiles table** - Address and emergency contact information
3. **Tier 3: patient_profiles table** - Patient number and cumulative medical record

This architecture ensures complete data availability for SOAP note auto-population while leveraging existing indexed views for performance.

### Pre-Call Context Snapshot

**Data Flow:**
```
Provider initiates call via joinRoom action
  ↓
create-context-snapshot edge function called
  ↓
Step 1: Query appointment_overview by encounter_id
  → Extract: patient_id, patient demographics, appointment context
  ↓
Step 2: Query users table by patient_id
  → Correct field names: date_of_birth (not dob), gender (not sex_at_birth), phone_number (not phone)
  ↓
Step 3: Query user_profiles by user_id
  → Extract: address, emergency_contact_name, emergency_contact_phone, emergency_contact_relationship
  ↓
Step 4: Query patient_profiles by user_id
  → Extract: patient_number, cumulative_medical_record
  ↓
Context snapshot created with complete patient_demographics + appointment_context
```

**patient_demographics TypeScript Interface (14 fields):**
```typescript
patient_demographics: {
  id: string;                                  // User ID
  full_name: string;                           // REQUIRED - from users.full_name or appointment_overview.patient_full_name
  patient_number?: string;                     // OPTIONAL - from patient_profiles.patient_number
  dob: string;                                 // REQUIRED - from users.date_of_birth (ISO format)
  age?: number;                                // REQUIRED - calculated from dob
  gender: string;                              // REQUIRED - from users.gender (NOT sex_at_birth)
  phone: string;                               // REQUIRED - from users.phone_number (NOT phone)
  email: string;                               // REQUIRED - from users.email
  address?: string;                            // OPTIONAL - from user_profiles.address
  emergency_contact_name?: string;             // OPTIONAL - from user_profiles
  emergency_contact_phone?: string;            // OPTIONAL - from user_profiles
  emergency_contact_relationship?: string;     // OPTIONAL - from user_profiles
  blood_type?: string;                         // OPTIONAL - from patient_profiles
  created_at: string;                          // Timestamp
}
```

**appointment_context TypeScript Interface (9 fields):**
```typescript
appointment_context: {
  appointment_id: string;                      // Unique appointment identifier
  appointment_number: string;                  // Human-readable reference (e.g., "APT-0042")
  chief_complaint?: string;                    // Pre-visit chief complaint from appointment
  appointment_type: string;                    // e.g., "Telehealth Video"
  specialty?: string;                          // Medical specialty (e.g., "Cardiology")
  scheduled_start: string;                     // ISO 8601 timestamp
  provider_name: string;                       // From medical_provider_profiles
  provider_specialty?: string;                 // Provider's specialty
  facility_name?: string;                      // From facilities table
}
```

**Field Name Mapping Reference:**
| Database Column | TypeScript Field | Why Important |
|---|---|---|
| users.date_of_birth | patient_demographics.dob | Phase 2 correction - code was querying 'dob' which doesn't exist |
| users.gender | patient_demographics.gender | Phase 2 correction - code was querying 'sex_at_birth' which is actually 'gender' |
| users.phone_number | patient_demographics.phone | Phase 2 correction - code was querying 'phone' which is actually 'phone_number' |
| user_profiles.address | patient_demographics.address | Phase 2 enhancement - added address field |
| user_profiles.emergency_contact_* | patient_demographics.emergency_contact_* | Phase 2 enhancement - added emergency contact fields |
| patient_profiles.patient_number | patient_demographics.patient_number | Phase 2 enhancement - added patient number field |

**Completeness Logging (creates audit trail):**
```typescript
console.log(`[create-context-snapshot] Snapshot completeness check:`);
console.log(`  - Patient Name: ${snapshot.patient_demographics.full_name ? '✓' : '✗'}`);
console.log(`  - DOB: ${snapshot.patient_demographics.dob ? '✓' : '✗'}`);
console.log(`  - Phone: ${snapshot.patient_demographics.phone ? '✓' : '✗'}`);
console.log(`  - Email: ${snapshot.patient_demographics.email ? '✓' : '✗'}`);
console.log(`  - Address: ${snapshot.patient_demographics.address ? '✓' : '✗ (optional)'}`);
console.log(`  - Emergency Contact: ${snapshot.patient_demographics.emergency_contact_name ? '✓' : '✗ (optional)'}`);
console.log(`  - Patient Number: ${snapshot.patient_demographics.patient_number ? '✓' : '✗ (optional)'}`);
console.log(`  - Blood Type: ${snapshot.patient_demographics.blood_type !== 'Unknown' ? '✓' : '✗ (optional)'}`);
```

### SOAP Note Generation

**Tab 1 - Encounter Header (uses appointment_context):**
- visit_date: appointment_context.scheduled_start
- visit_type: appointment_context.appointment_type
- chief_complaint_as_written: appointment_context.chief_complaint (enhanced from transcript if patient elaborates)
- appointment_number: appointment_context.appointment_number (for reference tracking)
- provider_name: appointment_context.provider_name
- facility_name: appointment_context.facility_name
- specialty: appointment_context.specialty

**Tab 2 - Patient Identification (extracted from patient_demographics):**

*Required Fields (must be populated):*
- full_name: patient_demographics.full_name
- dob: patient_demographics.dob (ISO format: YYYY-MM-DD)
- age: patient_demographics.age (calculated from dob)
- sex_at_birth: patient_demographics.gender
- phone: patient_demographics.phone
- email: patient_demographics.email

*Optional Fields (include if available):*
- address: patient_demographics.address
- emergency_contact_name: patient_demographics.emergency_contact_name
- emergency_contact_phone: patient_demographics.emergency_contact_phone
- emergency_contact_relationship: patient_demographics.emergency_contact_relationship
- patient_number: patient_demographics.patient_number
- blood_type: patient_demographics.blood_type

**Tab 2 Validation Mechanism (TypeScript code):**
```typescript
// Validate Tab 2 Patient Identification completeness
const tab2 = soapDraft.tab2_patient_identification || {};
const requiredFields = ['full_name', 'dob', 'age', 'sex_at_birth', 'phone', 'email'];
const missingRequired = requiredFields.filter(field => !tab2[field] || tab2[field] === '');

if (missingRequired.length > 0) {
  console.warn(`[generate-soap-draft-v2] ⚠️  Tab 2 missing required fields: ${missingRequired.join(', ')}`);
  
  // Initialize ai_flags
  if (!soapDraft.meta.ai_flags) {
    soapDraft.meta.ai_flags = { needs_clinician_confirmation: [], missing_critical_info: [] };
  }
  
  // Add each missing field to ai_flags
  missingRequired.forEach(field => {
    soapDraft.meta.ai_flags.missing_critical_info.push(`Tab 2: ${field} is missing - please fill manually`);
  });
  
  // Adjust confidence score: base 0.8, -0.2 per missing field, minimum 0.5
  soapDraft.meta.provenance.confidence = Math.max(0.5, soapDraft.meta.provenance.confidence - 0.2);
}

// Log optional fields status
const optionalFields = ['address', 'emergency_contact_name', 'emergency_contact_phone', 'patient_number'];
const presentOptional = optionalFields.filter(field => tab2[field] && tab2[field] !== '');
console.log(`[generate-soap-draft-v2] Tab 2 optional fields present: ${presentOptional.join(', ') || 'none'}`);
```

**Confidence Score System:**
- Base Score: 0.8 (80% confidence)
- Penalty: -0.2 (20%) per missing REQUIRED field
- Minimum Floor: 0.5 (50% - minimum usable score)
- Clinical Threshold: >0.70 (70%)

Example:
- All 6 required fields present: 0.8 confidence (✓ above threshold)
- 1 field missing (e.g., phone): 0.8 - 0.2 = 0.6 confidence (⚠️ below 0.70 threshold)
- 2 fields missing: 0.8 - 0.4 = 0.4 → floor to 0.5 confidence (⚠️ below threshold)

**ai_flags Error Tracking Structure:**
```typescript
ai_flags: {
  missing_critical_info: [
    "Tab 2: phone is missing - please fill manually",
    "Tab 2: address not available in patient records"
  ],
  needs_clinician_confirmation: [
    "emergency_contact_relationship unclear - verify with patient",
    "blood_type not documented - confirm type with patient"
  ]
}
```

### Complete Video Call Workflow (joinRoom Action)

**Stage 1: Pre-Call Assessment (Provider Only)**
- Show ChimePreJoiningDialog for device permissions
- Fetch patient demographics from previous calls
- Call create-context-snapshot to gather complete patient data (three-tier query)
- Fetch existing SOAP notes for context
- Provider reviews pre-populated patient information and appointment context

**Stage 2: Video Execution**
- Force-refresh Firebase token: `getIdToken(true)` (critical for edge function auth)
- Call chime-meeting-token edge function with 3-retry exponential backoff
- Initialize Chime SDK from CloudFront CDN
- Create or join meeting, stream real-time messages to chime_messages table
- Enable live captions with 3-5 second fade-out
- Accumulate transcript segments in StringBuffer, process every 12 seconds
- Prevent session timeout while call is active

**Stage 3: Post-Call Workflow**
- Stop real-time transcription capture
- Build speaker map from chime_messages data
- Initiate AWS Transcribe Medical job (async, 2-10 minute completion)
- Call generate-soap-draft-v2 with complete context snapshot + transcript
- Show PostCallClinicalNotesDialog with AI auto-populated 12-tab SOAP
- Provider reviews all tabs (especially Tab 2 Patient Demographics and Tab 1 Encounter Header)
- Provider adds/edits clinical notes as needed
- Provider confirms ai_flags and resolves missing_critical_info
- Provider signs and saves SOAP note to clinical_notes table
- System triggers async sync-to-ehrbase for OpenEHR integration



### Data Flow Diagram: Enhanced Video Call Workflow with Three-Tier Query Architecture

```
┌────────────────────────────────────────────────────────────────────────────────┐
│ STAGE 1: PRE-CALL CONTEXT GATHERING (create-context-snapshot)                 │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Provider Initiates Call → create-context-snapshot(encounter_id, appointment_id)│
│                                                                                  │
│  THREE-TIER QUERY ARCHITECTURE:                                               │
│  ┌─────────────────┐  ┌──────────────────┐  ┌──────────────────┐               │
│  │ Tier 1:         │  │ Tier 2:          │  │ Tier 3:          │               │
│  │appointment_     │  │user_profiles     │  │patient_profiles  │               │
│  │overview         │  │table             │  │table             │               │
│  │(denormalized)   │  │                  │  │                  │               │
│  ├─────────────────┤  ├──────────────────┤  ├──────────────────┤               │
│  │ Returns:        │  │ Returns:         │  │ Returns:         │               │
│  │ appointment_id  │  │ address          │  │ patient_number   │               │
│  │ patient_id      │  │ emergency_       │  │ cumulative_      │               │
│  │ patient_full_   │  │ contact_name     │  │ medical_record   │               │
│  │ name            │  │ emergency_       │  │ blood_type       │               │
│  │ patient_email   │  │ contact_phone    │  │                  │               │
│  │ patient_phone   │  │ emergency_       │  │                  │               │
│  │ chief_complaint │  │ contact_         │  │                  │               │
│  │ appointment_    │  │ relationship     │  │                  │               │
│  │ type            │  │                  │  │                  │               │
│  │ specialty       │  │                  │  │                  │               │
│  │ provider_full_  │  │                  │  │                  │               │
│  │ name            │  │                  │  │                  │               │
│  │ facility_name   │  │                  │  │                  │               │
│  └────────┬────────┘  └────────┬─────────┘  └────────┬─────────┘               │
│           │                    │                     │                         │
│           └────────────────────┼─────────────────────┘                         │
│                                ↓                                                │
│  CONTEXT SNAPSHOT (Stored in context_snapshots JSONB):                         │
│  ├─ patient_demographics (14 fields total):                                   │
│  │  ├─ REQUIRED (8): id, full_name, dob, age, gender, phone, email, created_at
│  │  └─ OPTIONAL (6): patient_number, address, emergency_contact_name,         │
│  │     emergency_contact_phone, emergency_contact_relationship, blood_type    │
│  ├─ appointment_context (9 fields):                                           │
│  │  └─ appointment_id, appointment_number, chief_complaint, appointment_type, │
│  │     specialty, scheduled_start, provider_name, provider_specialty,         │
│  │     facility_name                                                          │
│  └─ Medical History: active_conditions, medications, allergies, surgical_     │
│     history, family_history, social_history, recent_labs_vitals              │
│                                                                                  │
└────────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────────┐
│ STAGE 2 & 3: VIDEO CALL + SOAP GENERATION (generate-soap-draft-v2)            │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  During Call: Chime SDK streams video/audio + captures real-time transcription │
│                                                                                  │
│  Call Ends → generate-soap-draft-v2(context_snapshot, transcript)             │
│                                                                                  │
│  SOAP Generation Pipeline:                                                     │
│  1. Fetch context_snapshot (JSONB) + call transcript chunks                    │
│  2. Call AWS Bedrock (Claude) with enhanced prompt:                            │
│     - Emphasizes Tab 2 completeness (all 6 required fields)                    │
│     - Includes appointment_context in Tab 1 prompt                             │
│     - Validates all 12 SOAP tabs populated                                     │
│  3. AI generates SOAP draft with all 12 tabs                                   │
│                                                                                  │
│  ▼ VALIDATION CHECKPOINTS (before returning response):                        │
│                                                                                  │
│  ┌──────────────────────────────────────────────────────────────┐             │
│  │ TAB 2 VALIDATION: Patient Identification Required Fields    │             │
│  │ ✓ full_name    (from snapshot.patient_demographics.full_name)│             │
│  │ ✓ dob          (from snapshot.patient_demographics.dob)      │             │
│  │ ✓ age          (calculated from dob)                         │             │
│  │ ✓ sex_at_birth (from snapshot.patient_demographics.gender)   │             │
│  │ ✓ phone        (from snapshot.patient_demographics.phone)    │             │
│  │ ✓ email        (from snapshot.patient_demographics.email)    │             │
│  │                                                               │             │
│  │ OPTIONAL Tab 2 Fields (populate if available):              │             │
│  │ ○ patient_number (from snapshot.patient_demographics)        │             │
│  │ ○ address        (from snapshot.patient_demographics)        │             │
│  │ ○ emergency_contact_name/phone                               │             │
│  │                                                               │             │
│  │ IF Any Required Field Missing:                               │             │
│  │   → ai_flags.missing_critical_info = ["Tab 2: {field}..."]   │             │
│  │   → Confidence Score: 0.8 - (0.2 × missing_fields)           │             │
│  │   → Min floor: 0.5 (50% confidence)                          │             │
│  │                                                               │             │
│  │ Example Confidence Calculations:                             │             │
│  │   • All 6 required present: 0.8 ✓ (above 0.70 threshold)   │             │
│  │   • 1 field missing: 0.8 - 0.2 = 0.6 (below threshold)      │             │
│  │   • 2 fields missing: 0.8 - 0.4 = 0.4 → 0.5 floor           │             │
│  └──────────────────────────────────────────────────────────────┘             │
│                                                                                  │
│  ▼ SOAP RESPONSE (All 12 Tabs):                                                │
│  ├─ Tab 1: Encounter Header (includes appointment_context: id, number,        │
│  │  chief_complaint, provider, facility, specialty)                           │
│  ├─ Tab 2: Patient Identification (all demographics from snapshot)            │
│  ├─ Tabs 3-12: Clinical findings (from transcript + medical history)          │
│  └─ meta.ai_flags: { missing_critical_info: [...], needs_clinician_          │
│     confirmation: [...], confidence: <0.5-1.0> }                              │
│                                                                                  │
│  ▼ POST-CALL WORKFLOW:                                                         │
│  Provider Reviews SOAP in PostCallClinicalNotesDialog:                         │
│  • Verifies Tab 2 Patient Demographics is complete                            │
│  • Verifies Tab 1 Encounter Header has appointment context                    │
│  • Reviews ai_flags for missing_critical_info requiring manual input          │
│  • Edits/confirms clinical notes                                              │
│  • Signs and saves SOAP to clinical_notes table                               │
│  • Triggers async sync-to-ehrbase for OpenEHR integration                     │
│                                                                                  │
└────────────────────────────────────────────────────────────────────────────────┘
```


## Real-Time Transcription

- Segments accumulate in StringBuffer (prevent bloat)
- Process every 12 seconds (configurable)
- Prevent concurrent processing with `_isProcessingTranscript` flag
- Track processed IDs (500-msg limit)
- Caption text fades after 3-5 sec

## Database Tables Summary

**Users/Profiles:** users (firebase_uid, lat/lng + PostGIS), patient_profiles, medical_provider_profiles, facility_admin_profiles, system_admin_profiles, facilities

**Appointments/Calls:** appointments, video_call_sessions, chime_messages, call_notifications, transcription_usage_daily

**AI/Clinical:** ai_assistants, ai_conversations, ai_messages, clinical_notes, ehrbase_sync_queue

**Pharmacy:** pharmacy_products, pharmacy_inventory, user_cart, user_wishlist, user_addresses, pharmacy_orders, pharmacy_order_items, product_reviews, order_tracking, pharmacy_coupons, coupon_usage

**Other:** active_sessions, language_preferences, custom_vocabularies, Storage: chime_storage, profile_pictures

## Error Codes

- **401 INVALID_FIREBASE_TOKEN**: Token invalid/expired/malformed
- **403 PATIENT_CANNOT_CREATE**: Patients can't initiate calls
- **403 INSUFFICIENT_PERMISSIONS**: Lacks role/authorization
- **404 NO_ACTIVE_CALL**: Meeting doesn't exist/inactive
- **410 MEETING_EXPIRED**: Meeting ended/finalized
- **503 TRANSCRIPTION_NOT_AVAILABLE**: AWS Transcribe unavailable

## AI & LLM Integration

**Providers:** OpenAI, Google GenAI (Gemini), Anthropic (Claude), AWS Bedrock

**Patterns:** Sequential chains (transcription → SOAP), conversation chains with memory, document loaders (EHRbase), output parsers (structured extraction)

**Firebase Functions:** Use LangChain for orchestrating Firebase/Supabase/AWS workflows

## Payment Processing

**Providers:** Stripe (cards), Braintree (PayPal/cards), Razorpay (India)

**Flow:** Add to user_cart → create order → webhook confirms → mark paid → reserve stock → track order

**Config:** Store credentials in Firebase config (never hardcode)

## Pharmacy E-Commerce (Jan 13, 2026)

**Actions:** calculateCartTotal, validateCouponCode, checkProductStock, reserveProductStock, getNearbyPharmacies

**Views:** product_catalog_view, low_stock_products, expired_products, top_selling_products, user_cart_with_details, pharmacy_orders_with_details

**Test:** `./test_all_systems.sh` or `verify_pharmacy_system.js`

## Development Workflows

**Start Session:**
```bash
nvm use 20 && flutter pub get && cd firebase/functions && npm install && cd ../..
npx supabase link --project-ref noaeltglphdlkbflipit
flutter run -d chrome
npx supabase functions logs [name] --tail  # in another terminal
```

**Add Edge Function:**
1. Create `supabase/functions/[name]/index.ts`
2. Add to `supabase/functions/_shared/` if needed
3. Deploy: `npx supabase functions deploy [name]`
4. View logs: `npx supabase functions logs [name] --tail`

**Modify Schema:**
1. Create new migration: `supabase/migrations/YYYYMMDDHHMMSS_description.sql`
2. Test locally: `npx supabase db reset`
3. Deploy: `npx supabase db push`

## Environment & Versions

**Check:** `node --version` (20.x), `flutter --version` (>=3.0.0 <4.0.0), `firebase --version`, `npm --version`

**Never commit:** `.env`, `credentials.json`, `environment.json`, service keys, `node_modules/`, `build/`, `.dart_tool/`

## Helper Scripts

**Testing:** test_all_systems.sh, test_user_creation_flow.sh, test_video_call_web_automated.sh, test_role_based_ai_models_complete.sh

**Mobile:** fix_emulator_camera.sh, test_android_video_fix.sh, test_video_call_android_automated.sh

**Clinical:** test_clinical_note_workflow.sh, test_transcription_automated.sh, test_ehr_sync_complete.sh

**Database:** check_schema.sh, verify_appointments.sh, update_appointments_to_today.sh

**Verification:** validate-critical-functions.sh, verify_onusercreated.sh, verify_flutterflow_cleanup.sh

**Deployment:** deploy_specialty_tables.sh, setup-automated-backups.sh, test-phase1-security.sh

## MCP Servers (.mcp.json)

Available MCP servers configured for Claude Code context-aware assistance:

| Server | Purpose | Key Resources |
|--------|---------|----------------|
| **supabase** | Query/manage Supabase DB, edge functions, storage | Tables, edge functions, migrations |
| **firebase-mcp** | Inspect Firebase functions, auth, Firestore | Cloud Functions, Auth rules |
| **openEHR** | Access EHRbase clinical templates & data | Clinical records, templates |
| **powersync** | Query PowerSync sync engine state | Sync queue, tables, conflicts |
| **pfsense** | Manage firewall rules (networking) | Firewall rules, interfaces, NAT |
| **flutterflow** | Inspect FlutterFlow project structure | Pages, components, versions |

These provide Claude Code with real-time access to your infrastructure state for better troubleshooting.

## Performance Tips

- **Profile:** `flutter run -d chrome --profile` → DevTools Performance
- **Slow queries:** Use `pg_stat_statements`; add indexes on user_id, firebase_uid, appointment_id
- **Transcription:** 2-10 min; show progress UI, don't block
- **Chime SDK:** Loads from CloudFront; pre-cache or use service worker
- **Realtime:** Avoid subscribing to large tables; use filters
- **Queries:** Batch instead of N+1 loops
- **Large widgets:** Use `const` constructors; profile ChimeMeetingEnhanced (~6.6k lines) separately

## External Resources

- [Flutter](https://flutter.dev/docs) | [Supabase](https://supabase.com/docs) | [Firebase](https://firebase.google.com/docs) | [AWS Chime SDK](https://docs.aws.amazon.com/chime-sdk/) | [AWS Bedrock](https://docs.aws.amazon.com/bedrock/)

## Session Security

- Single-device login via `active_device_id`
- 5-min inactivity timeout (paused during calls)
- Force logout on new device
