{
  "name": "ehrbase-ecr-migration",
  "description": "Migrate EHRbase Docker image from Docker Hub to ECR",
  "source": {
    "type": "NO_SOURCE",
    "buildspec": "version: 0.2\n\nphases:\n  pre_build:\n    commands:\n      - echo Logging in to Amazon ECR...\n      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com\n      - REPOSITORY_URI=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME\n      - IMAGE_TAG=2.24.0\n      - echo Repository URI is $REPOSITORY_URI\n      - echo Image tag is $IMAGE_TAG\n\n  build:\n    commands:\n      - echo Pulling image from Docker Hub...\n      - docker pull ehrbase/ehrbase:$IMAGE_TAG\n      - echo Tagging image for ECR...\n      - docker tag ehrbase/ehrbase:$IMAGE_TAG $REPOSITORY_URI:$IMAGE_TAG\n      - docker tag ehrbase/ehrbase:$IMAGE_TAG $REPOSITORY_URI:latest\n      - echo Build completed on `date`\n\n  post_build:\n    commands:\n      - echo Pushing the Docker image to ECR...\n      - docker push $REPOSITORY_URI:$IMAGE_TAG\n      - docker push $REPOSITORY_URI:latest\n      - echo Push completed on `date`\n      - echo Image URI is $REPOSITORY_URI:$IMAGE_TAG\n"
  },
  "artifacts": {
    "type": "NO_ARTIFACTS"
  },
  "environment": {
    "type": "LINUX_CONTAINER",
    "image": "aws/codebuild/standard:7.0",
    "computeType": "BUILD_GENERAL1_SMALL",
    "environmentVariables": [
      {
        "name": "AWS_DEFAULT_REGION",
        "value": "af-south-1",
        "type": "PLAINTEXT"
      },
      {
        "name": "AWS_ACCOUNT_ID",
        "value": "558069890522",
        "type": "PLAINTEXT"
      },
      {
        "name": "IMAGE_REPO_NAME",
        "value": "ehrbase",
        "type": "PLAINTEXT"
      }
    ],
    "privilegedMode": true
  },
  "serviceRole": "arn:aws:iam::558069890522:role/ehrbase-codebuild-ecr-migration-role",
  "timeoutInMinutes": 30
}
